<%
  rsyslog_kafka_space = p("rsyslog_kafka.space") == "spec.deployment" ? spec.deployment : p("rsyslog_kafka.space")
  rsyslog_kafka_service = p("rsyslog_kafka.service") == "name" ? name : p("rsyslog_kafka.service")
  rsyslog_kafka_index = p("rsyslog_kafka.index") == "index" ? index : p("rsyslog_kafka.index")
%>

template(name="kafka_template" type="list") {
  constant(value="|||")
  constant(value="type=backingservice")
  constant(value="|||")
  constant(value="org=<%= p('rsyslog_kafka.org') %>")
  constant(value="|||")
  constant(value="space=<%= rsyslog_kafka_space %>")
  constant(value="|||")
  constant(value="service=<%= rsyslog_kafka_service %>")
  constant(value="|||")
  constant(value="version=1.0")
  constant(value="|||")
  constant(value="instance=<%= rsyslog_kafka_index %>")
  constant(value="|||")
  constant(value="timestamp=")
  property(name="timestamp" dateFormat="unixtimestamp")
  property(name="timestamp" dateFormat="subseconds")
  constant(value="000")
  constant(value="|||")
  constant(value="level=")
  property(name="syslogseverity-text")
  constant(value="|||")
  constant(value="logger=")
  property(name="programname")
  constant(value="|||")
  constant(value="message=")
  property(name="msg")
  constant(value="|||\n")
}

$ModLoad omprog
action(type="omprog" binary="/var/vcap/packages/gomkafka/var/vcap/bin/gomkafka <%= p("rsyslog_kafka.brokers").join(',') %> <%= p('rsyslog_kafka.topic') %>" template="kafka_template")
